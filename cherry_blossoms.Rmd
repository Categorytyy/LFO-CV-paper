---
title: "LFO-CV of Cherry Blossoms Data"
author: "Paul BÃ¼rkner & Aki Vehtari"
output:
  html_document:
    theme: default
encoding: UTF-8
editor_options: 
  chunk_output_type: console
---

<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>

---

# {.tabset}

## Setup

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(cache = TRUE, fig.width = 10)
```

```{r general_options, cache=FALSE}
source("sim_functions.R")
library(tidyverse)
library(brms)
options(width = 160, mc.cores = 2)
theme_set(theme_default())
```

```{r}
cherry <- read.csv("data/cherry_blossoms.csv")
cherry_temp <- cherry[!is.na(cherry$temp), ]
cherry_doy <- cherry[!is.na(cherry$doy), ]
```

## Model

Fit a spline model:
```{r}
fit_cb <- brm(
  formula = bf(doy ~ s(year, k = 40)),
  data = cherry_doy, chain = 2, seed = 583829, 
  control = list(adapt_delta = 0.99),
  file = "models/fit_cb"
)
plot(marginal_effects(fit_cb), points = TRUE)
```

## LFO-CV with 1-SAP

Perform exact LFO-CV:
```{r}
L <- 100
M <- 1
exact_lfo_cb <- compute_lfo(
  fit_cb, type = "exact", M = M, L = L, 
  file = "results/exact_lfo_1sap_cb.rds"
)
summarize_elpds(exact_lfo_cb)
```

Perform approximate LFO-CV:
```{r}
approx_lfo_cb <- compute_lfo(
  fit_cb, type = "approx", M = M, L = L, 
  file = "results/approx_lfo_1sap_cb.rds"
)
summarize_elpds(approx_lfo_cb)
```

Perform approximate LOO-CV:
```{r}
(loo_cb <- loo(fit_cb, newdata = cherry_doy[-seq_len(L), ]))
```

